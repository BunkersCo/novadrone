'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _toConsumableArray2 = require('babel-runtime/helpers/toConsumableArray');

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _typeof2 = require('babel-runtime/helpers/typeof');

var _typeof3 = _interopRequireDefault(_typeof2);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var MAX_PORT = 65535;

exports.default = function () {
  var ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(portOrRange, extraListenArgs, createFn) {
    var _this = this;

    var lowPort, highPort, lastErr, _loop, port, _ret;

    return _regenerator2.default.wrap(function _callee$(_context2) {
      while (1) {
        switch (_context2.prev = _context2.next) {
          case 0:
            lowPort = undefined, highPort = undefined;

            if (typeof portOrRange === 'number') {
              lowPort = portOrRange;
              highPort = MAX_PORT;
            } else {
              lowPort = portOrRange[0];
              highPort = Math.min(MAX_PORT, portOrRange[1]);
            }

            lastErr = null;
            _loop = _regenerator2.default.mark(function _loop(port) {
              var server, errorHandler;
              return _regenerator2.default.wrap(function _loop$(_context) {
                while (1) {
                  switch (_context.prev = _context.next) {
                    case 0:
                      server = createFn();
                      errorHandler = undefined;
                      _context.prev = 2;
                      _context.next = 5;
                      return new _promise2.default(function (resolve, reject) {
                        errorHandler = reject;
                        server.addListener('error', errorHandler);
                        server.listen.apply(server, [port].concat((0, _toConsumableArray3.default)(extraListenArgs || []), [function (err) {
                          if (err) reject(err);else resolve();
                        }]));
                      });

                    case 5:
                      server.removeListener('error', errorHandler);
                      return _context.abrupt('return', {
                        v: server
                      });

                    case 9:
                      _context.prev = 9;
                      _context.t0 = _context['catch'](2);

                      server.removeListener('error', errorHandler);

                      if (!(!_context.t0 || _context.t0.code !== 'EADDRINUSE')) {
                        _context.next = 14;
                        break;
                      }

                      throw _context.t0;

                    case 14:
                      lastErr = _context.t0;

                    case 15:
                    case 'end':
                      return _context.stop();
                  }
                }
              }, _loop, _this, [[2, 9]]);
            });
            port = lowPort;

          case 5:
            if (!(port <= highPort)) {
              _context2.next = 13;
              break;
            }

            return _context2.delegateYield(_loop(port), 't0', 7);

          case 7:
            _ret = _context2.t0;

            if (!((typeof _ret === 'undefined' ? 'undefined' : (0, _typeof3.default)(_ret)) === "object")) {
              _context2.next = 10;
              break;
            }

            return _context2.abrupt('return', _ret.v);

          case 10:
            port++;
            _context2.next = 5;
            break;

          case 13:
            throw lastErr || new Error("Failed to find free port");

          case 14:
          case 'end':
            return _context2.stop();
        }
      }
    }, _callee, this);
  }));
  return function listenOnFreePort(_x, _x2, _x3) {
    return ref.apply(this, arguments);
  };
}();

module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBUUEsSUFBTSxXQUFXLEtBQVg7Ozt1RUFFUyxpQkFDYixXQURhLEVBRWIsZUFGYSxFQUdiLFFBSGE7OztRQUtULFNBQVMsVUFTVCxnQkFDSzs7Ozs7O0FBVkwsaUNBQVM7O0FBQ2IsZ0JBQUksT0FBTyxXQUFQLEtBQXVCLFFBQXZCLEVBQWlDO0FBQ25DLHdCQUFVLFdBQVYsQ0FEbUM7QUFFbkMseUJBQVcsUUFBWCxDQUZtQzthQUFyQyxNQUdPO0FBQ0wsd0JBQVUsWUFBWSxDQUFaLENBQVYsQ0FESztBQUVMLHlCQUFXLEtBQUssR0FBTCxDQUFTLFFBQVQsRUFBbUIsWUFBWSxDQUFaLENBQW5CLENBQVgsQ0FGSzthQUhQOztBQVFJLHNCQUFVOzhEQUNMO2tCQUNELFFBQ0Y7Ozs7O0FBREUsK0JBQVM7QUFDWDs7OzZCQUVJLHNCQUFZLFVBQUMsT0FBRCxFQUFVLE1BQVYsRUFBcUI7QUFDckMsdUNBQWUsTUFBZixDQURxQztBQUVyQywrQkFBTyxXQUFQLENBQW1CLE9BQW5CLEVBQTRCLFlBQTVCLEVBRnFDO0FBR3JDLCtCQUFPLE1BQVAsZ0JBQWMsOENBQVUsbUJBQW1CLEVBQW5CLElBQXdCLGVBQU87QUFDckQsOEJBQUksR0FBSixFQUNFLE9BQU8sR0FBUCxFQURGLEtBR0UsVUFIRjt5QkFEOEMsRUFBaEQsRUFIcUM7dUJBQXJCOzs7QUFVbEIsNkJBQU8sY0FBUCxDQUFzQixPQUF0QixFQUErQixZQUEvQjs7MkJBQ087Ozs7Ozs7QUFFUCw2QkFBTyxjQUFQLENBQXNCLE9BQXRCLEVBQStCLFlBQS9COzs0QkFDSSxnQkFBUSxZQUFJLElBQUosS0FBYSxZQUFiOzs7Ozs7OztBQUdaOzs7Ozs7Ozs7QUFyQkssbUJBQUs7OztrQkFBUyxRQUFNLFFBQU47Ozs7O2lEQUFkOzs7Ozs7Ozs7Ozs7O0FBQThCOzs7OztrQkF3QmpDLFdBQVcsSUFBSSxLQUFKLENBQVUsMEJBQVYsQ0FBWDs7Ozs7Ozs7R0F2Q087a0JBQWUiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBAZmxvdyAqL1xuXG50eXBlIFNlcnZlciA9IHtcbiAgbGlzdGVuOiBGdW5jdGlvbjtcbiAgYWRkTGlzdGVuZXI6IEZ1bmN0aW9uO1xuICByZW1vdmVMaXN0ZW5lcjogRnVuY3Rpb247XG59O1xuXG5jb25zdCBNQVhfUE9SVCA9IDY1NTM1O1xuXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiBsaXN0ZW5PbkZyZWVQb3J0PFM6IFNlcnZlcj4oXG4gIHBvcnRPclJhbmdlOiBudW1iZXJ8W251bWJlciwgbnVtYmVyXSxcbiAgZXh0cmFMaXN0ZW5BcmdzOiA/QXJyYXk8YW55PixcbiAgY3JlYXRlRm46ICgpPT5TXG4pOiBQcm9taXNlPFM+IHtcbiAgbGV0IGxvd1BvcnQsIGhpZ2hQb3J0O1xuICBpZiAodHlwZW9mIHBvcnRPclJhbmdlID09PSAnbnVtYmVyJykge1xuICAgIGxvd1BvcnQgPSBwb3J0T3JSYW5nZTtcbiAgICBoaWdoUG9ydCA9IE1BWF9QT1JUO1xuICB9IGVsc2Uge1xuICAgIGxvd1BvcnQgPSBwb3J0T3JSYW5nZVswXTtcbiAgICBoaWdoUG9ydCA9IE1hdGgubWluKE1BWF9QT1JULCBwb3J0T3JSYW5nZVsxXSk7XG4gIH1cblxuICBsZXQgbGFzdEVyciA9IG51bGw7XG4gIGZvciAobGV0IHBvcnQ9bG93UG9ydDsgcG9ydDw9aGlnaFBvcnQ7IHBvcnQrKykge1xuICAgIGNvbnN0IHNlcnZlciA9IGNyZWF0ZUZuKCk7XG4gICAgbGV0IGVycm9ySGFuZGxlcjtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBlcnJvckhhbmRsZXIgPSByZWplY3Q7XG4gICAgICAgIHNlcnZlci5hZGRMaXN0ZW5lcignZXJyb3InLCBlcnJvckhhbmRsZXIpO1xuICAgICAgICBzZXJ2ZXIubGlzdGVuKHBvcnQsIC4uLihleHRyYUxpc3RlbkFyZ3MgfHwgW10pLCBlcnIgPT4ge1xuICAgICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICBlbHNlXG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgICBzZXJ2ZXIucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgZXJyb3JIYW5kbGVyKTtcbiAgICAgIHJldHVybiBzZXJ2ZXI7XG4gICAgfSBjYXRjaChlcnIpIHtcbiAgICAgIHNlcnZlci5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBlcnJvckhhbmRsZXIpO1xuICAgICAgaWYgKCFlcnIgfHwgZXJyLmNvZGUgIT09ICdFQUREUklOVVNFJykge1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgICBsYXN0RXJyID0gZXJyO1xuICAgIH1cbiAgfVxuICB0aHJvdyBsYXN0RXJyIHx8IG5ldyBFcnJvcihcIkZhaWxlZCB0byBmaW5kIGZyZWUgcG9ydFwiKTtcbn1cbiJdfQ==